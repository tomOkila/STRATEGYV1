@page "/manageplan"
<PageTitle>STRATEGY | Manage Plan</PageTitle>
<div class="row">
    <div class="col-sm-12 mb-4 mb-xl-0">
        <h4 class="font-weight-bold text-dark">Manage Plan</h4>
        <div style="float:right;">
            <RadzenBreadCrumb>
                <RadzenBreadCrumbItem Path="/manageplandetails" Text="Home" />
                <RadzenBreadCrumbItem Text="Manage Plan" />
            </RadzenBreadCrumb>
        </div>
    </div>

</div>
<div class="card card-primary">
    <div class="card-header text-white" Style="background-color: #EC37FC;font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif">
        @* <h3 class="card-title"><i class="fas fa-user-plus"></i> Create Strategic Plan</h3> *@
    </div>
    <!-- /.card-header -->
    <div class="card-body">
        <RadzenStack>
            <RadzenTemplateForm TItem="StrategicPlan" Data=strategicPlan Submit="Save" InvalidSubmit="OnInvalidSubmit">
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="6" SizeSM="6">
                        <RadzenStack Gap="0.1rem">
                            <RadzenLabel Text="Strategic Plan Name: " Style="font-weight:bold;color:black" />
                            <RadzenTextBox Name="StrategicPlanName" @bind-Value=strategicPlan.StrategicPlanName />
                            <RadzenRequiredValidator Component="StrategicPlanName" Text="Strategic Plan Name is required" />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" SizeSM="6">
                        <RadzenStack>
                            <RadzenStack Gap="0.1rem">
                            <RadzenLabel Text="Pillar: " Style="font-weight:bold;color:black;padding:0px;margin:0px;" />
                            <!--Dropdown Input Field-->
                            <RadzenDropDown Data=@pillars
                                            @bind-Value=strategicPlan.PillarID
                                            TextProperty="PillarName"
                                            AllowFiltering="true"
                                            FilterAsYouType="true"
                                            FilterPlaceholder="Select Pillar Name"
                                            Placeholder="Select Pillar Name"
                                            ValueProperty="PillarID"
                                            Name="PillarName"
                                            Style="font-weight:bold">
                            </RadzenDropDown>
                            <RadzenRequiredValidator DefaultValue=0 Component="PillarName" Text="Pillar Name is required." />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="6" SizeSM="6">
                            <RadzenStack Gap="0.1rem">
                                <RadzenLabel Text="Strategic Objectives: " Style="font-weight:bold;color:black;padding:0px;margin:0px;" />
                                <!--Dropdown Input Field-->
                                <RadzenDropDown Data=@strategicObjectives.Where(x=>x.PillarId==strategicPlan.PillarID)
                                                @bind-Value=strategicPlan.SOId
                                                TextProperty="TargetName"
                                                AllowFiltering="true"
                                                FilterAsYouType="true"
                                                FilterPlaceholder="Select Strategic Objectives"
                                                Placeholder="Select Strategic Objectives"
                                                ValueProperty="SOId"
                                                Name="TargetName"
                                                Style="font-weight:bold">
                                </RadzenDropDown>
                                <RadzenRequiredValidator DefaultValue=0 Component="TargetName" Text="Target Name is required." />
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6" SizeSM="6">
                        <RadzenStack>
                            <RadzenStack Gap="0.1rem">
                                <RadzenLabel Text="Detailed Strategic Objectives: " Style="font-weight:bold;color:black;padding:0px;margin:0px;" />
                                <!--Dropdown Input Field-->
                                <RadzenDropDown Data=@detailedSOs.Where(x=>x.SOId==strategicPlan.SOId)
                                                @bind-Value=strategicPlan.DetailedId
                                                TextProperty="DetailedTargetName"
                                                AllowFiltering="true"
                                                FilterAsYouType="true"
                                                FilterPlaceholder="Select Detailed Target Name"
                                                Placeholder="Select Detailed Target Name"
                                                ValueProperty="DetailedId"
                                                Name="DetailedTargetName"
                                                Style="font-weight:bold">
                                </RadzenDropDown>
                                <RadzenRequiredValidator DefaultValue=0 Component="DetailedTargetName" Text="Detailed TargetName is required." />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>

                </RadzenRow>
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="6" SizeSM="6">
                            <RadzenStack Gap="0.1rem">
                                <RadzenLabel Text="Program Schedule: " Style="font-weight:bold;color:black;padding:0px;margin:0px;" />
                                <!--Dropdown Input Field-->
                                <RadzenDropDown Data=@programSchedules.Where(x=>x.DetailedId==strategicPlan.DetailedId)
                                                @bind-Value=strategicPlan.ProgramScheduleId
                                                TextProperty="ProgramRegistrarName"
                                                AllowFiltering="true"
                                                FilterAsYouType="true"
                                                FilterPlaceholder="Select Program Schedule"
                                                Placeholder="Select Program Schedule"
                                                ValueProperty="ProgramScheduleId"
                                                Name="ProgramRegistrarName"
                                                Style="font-weight:bold">
                                </RadzenDropDown>
                                <RadzenRequiredValidator DefaultValue=0 Component="ProgramRegistrarName" Text="Program Schedule is required." />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
              

                <RadzenButton Style="margin-top:20px;" Icon="save" ButtonType="ButtonType.Submit" Text="Submit"></RadzenButton>
            </RadzenTemplateForm>
        </RadzenStack>
    </div>
    <!-- /.card-body -->
    <div class="card-footer">
    </div>
</div>
<!-- /.card -->
@code {
    private string SessionName = string.Empty;
    private string SessionEmail = string.Empty;
    private int UserId;
    [CascadingParameter]
    public Task<AuthenticationState>? ClientAuthState { get; set; }


    StrategicPlan strategicPlan = new();
    List<StrategicPlan> strategicPlans = new();
    IList<StrategicPlan> selectedStrategicPlans;

    StrategicPlanReponse strategicPlanResponse = new();
    List<StrategicPlanReponse> strategicPlanResponses = new();

    Pillar pillar = new();
    List<Pillar> pillars = new();

    StrategicObjective strategicObjective = new();
    List<StrategicObjective> strategicObjectives = new();

    DetailedSO detailedSO = new();
    List<DetailedSO> detailedSOs = new();

    ProgramSchedule programSchedule = new();
    List<ProgramSchedule> programSchedules = new();

    private async Task GetStrategicPlans() => strategicPlanResponses = await strategyService.GetStrategicPlanAsync(UserId);
    private async Task GetPillars() => pillars = await strategyService.GetPillarAsync(UserId);
    private async Task GetStrategicObjectives() => strategicObjectives = await strategyService.GetStrategicObjectivesAsync(UserId);
    private async Task GetDetailedStrategicObjectives() => detailedSOs = await strategyService.GetDetailedStrategicObjectivesAsync(UserId);
    private async Task GetProgramSchedule() => programSchedules = await strategyService.GetProgramScheduleAsync(UserId);

    protected override async Task OnInitializedAsync()
    {

        try
        {
            var user = (await ClientAuthState).User;
            SessionName = user.Identity.Name;
            SessionEmail = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email).Value;
            UserId = Convert.ToInt32(user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier).Value);

            //load system roles
            await GetStrategicPlans();
            await GetPillars();
            await GetStrategicObjectives();
            await GetDetailedStrategicObjectives();
            await GetProgramSchedule();

            selectedStrategicPlans = new List<StrategicPlan>() { strategicPlans.FirstOrDefault() };
        }
        catch (Exception ex)
        {
            SessionName = null!;
            SessionEmail = null!;
        }


        base.OnInitialized();
        strategicPlan = myStateContainer.StrategicPlanValue;

    }


    async Task Save()
    {


        try
        {
            if (string.IsNullOrEmpty(strategicPlan.StrategicPlanName))
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = $"Please supply all plan details before proceeding.", Detail = "", Duration = 7000, CloseOnClick = true, Payload = DateTime.Now });
                return;
            }


            var response = new GeneralResponse(false, null!);
            if (strategicPlan.StrategicPlanID > 0)
                response = await strategyService.UpdateStrategicPlanAsync(strategicPlan);
            else
                response = await strategyService.CreateStrategicPlanAsync(strategicPlan);

            if (!response.Flag)
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = response.Message, Detail = "", Duration = 7000, CloseOnClick = true, Payload = DateTime.Now });
                return;
            }
            else
            {
                DialogService1.Close();
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = response.Message, Detail = "", Duration = 7000, CloseOnClick = true, Payload = DateTime.Now });
                await GetStrategicPlans();
                strategicPlan = new();
                Navmanager.NavigateTo("manageplandetails");
            }
        }
        catch (Exception ex)
        {
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = ex.ToString(), Detail = "", Duration = 7000, CloseOnClick = true, Payload = DateTime.Now });
            return;
        }


    }


    void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    {
        ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = $"InvalidSubmit: {JsonSerializer.Serialize(args, new JsonSerializerOptions() { WriteIndented = true })}", Detail = "", Duration = 2000, CloseOnClick = true, Payload = DateTime.Now });
    }

    void ShowNotification(Radzen.NotificationMessage message)
    {
        NotificationService.Notify(message);
    }
}
